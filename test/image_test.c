#include "bytecode/image.h"

u32 padToAlign(u32 n);

Err *gs_main(void) {
  Image img;

  GS_FAIL_IF(padToAlign(0) != 0, "failed padding 0", NULL);
  GS_FAIL_IF(padToAlign(1) != 4, "failed padding 1", NULL);

  alignas(u32) u8 buf[] = {
    'g', 'l', 's', '\0', // magic header
    0x01, 0x00, 0x00, 0x00, // version
    0x01, 0x00, 0x00, 0x00, // constant section
    0x04, 0x00, 0x00, 0x00, //  [length]
    0x03, 0x00, 0x00, 0x00, //   [0]: symbol
    0x03, 0x00, 0x00, 0x00, //    [length]
    'h', 'o', 'w', 0,
    0x02, 0x00, 0x00, 0x00, //   [1]: number
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x00, 0x00, 0x00, //   [2]: list
    0x02, 0x00, 0x00, 0x00, //    [length]
    0x00, 0x00, 0x00, 0x00, //     [0]
    0x01, 0x00, 0x00, 0x00, //     [1]
    0x00, 0x00, 0x00, 0x00, //   [3]: lambda
    0x00, 0x00, 0x00, 0x00, //      , code
    0x01, 0x00, 0x00, 0x00, //    [length]
    0x02, 0x00, 0x00, 0x00, //     [0]
    0x02, 0x00, 0x00, 0x00, // code section
    0x01, 0x00, 0x00, 0x00, //  [length]
    0x01, 0x00, 0x00, 0x00, //   [0]: len
    0x00, 0x00, 0x00, 0x00, //      , locals
    0x01, 0x00, 0x00, 0x00, //      , maxStack
    0x00, 0x00, 0x00, 0x00, //      , code
    0x03, 0x00, 0x00, 0x00, // bindings
    0x01, 0x00, 0x00, 0x00, //  [length]
    0x00, 0x00, 0x00, 0x00, //   [0]: name
    0x03, 0x00, 0x00, 0x00, //      , value
    0x04, 0x00, 0x00, 0x00, // start
    0x00, 0x00, 0x00, 0x00, //   code
  };
  GS_TRY(indexImage(sizeof(buf), buf, &img));

  GS_RET_OK;
}
